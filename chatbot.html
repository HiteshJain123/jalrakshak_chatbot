<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jalrakshak Interactive Prototype</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #E5DDD5;
        }
        .whatsapp-bg {
            background-image: url('https://i.pinimg.com/736x/8c/98/99/8c98994518b575bfd8c949e91d20548b.jpg');
        }
        .chat-bubble {
            max-width: 85%;
            padding: 8px 12px;
            border-radius: 12px;
            position: relative;
            word-wrap: break-word;
            white-space: pre-wrap;
        }
        .chat-bubble.user {
            background-color: #DCF8C6;
            align-self: flex-end;
        }
        .chat-bubble.bot {
            background-color: #FFFFFF;
            align-self: flex-start;
        }
        .chat-time {
            font-size: 0.7rem;
            color: #999;
            float: right;
            margin-left: 8px;
            margin-top: 4px;
        }

        .image-bubble, .location-bubble {
            padding: 4px;
            border-radius: 12px;
            position: relative;
            word-wrap: break-word;
            white-space: pre-wrap;
        }
        .image-bubble.user, .location-bubble.user {
            background-color: #DCF8C6;
            align-self: flex-end;
        }
        .image-bubble.bot, .location-bubble.bot {
            background-color: #FFFFFF;
            align-self: flex-start;
        }

        .options-container {
            align-self: flex-start;
            width: 100%;
            max-width: 90%;
        }

        @keyframes pop-in {
            0% { transform: scale(0.8); opacity: 0; }
            80% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }
        .chat-message {
            animation: pop-in 0.3s ease-out forwards;
            transform-origin: bottom left;
        }
        .chat-message.user-message {
            transform-origin: bottom right;
        }
        
        .chat-button {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .chat-button:hover {
            background-color: #f0f8ff;
        }
        .severity-button:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        .chat-date {
            align-self: center;
            background-color: #eaeaea;
            color: #555;
            font-size: 0.75rem;
            font-weight: 500;
            padding: 4px 10px;
            border-radius: 10px;
            margin: 10px auto;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen bg-gray-200 p-4">

    <div class="w-full max-w-sm h-[85vh] max-h-[750px] bg-white rounded-3xl shadow-2xl border-4 border-gray-800 overflow-hidden flex flex-col">
        
        <header class="bg-[#075E54] text-white p-3 flex items-center shadow-md z-10">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            <img src="https://placehold.co/40x40/34B7F1/FFFFFF?text=J" alt="Jalrakshak Logo" class="w-10 h-10 rounded-full mr-3 border-2 border-white">
            <div>
                <h1 class="font-bold text-lg">Jalrakshak</h1>
                <p class="text-xs opacity-80">typing...</p>
            </div>
        </header>

        <main id="chat-area" class="flex-1 p-4 overflow-y-auto flex flex-col space-y-4 whatsapp-bg"></main>

        <footer class="bg-gray-100 p-2 flex items-center border-t border-gray-200">
            <input id="user-input" type="text" placeholder="Type a message..." class="flex-1 bg-white rounded-full py-2 px-4 focus:outline-none" disabled>
            <button id="send-button" class="bg-[#25D366] text-white rounded-full p-3 ml-2 cursor-not-allowed" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </button>
        </footer>
    </div>

    <script>
        const chatArea = document.getElementById('chat-area');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const botStatus = document.querySelector('header p');

        let botTyping = false;
        let currentState = 'START';

        const botFlow = {
            'START': {
                message: 'Hello and welcome to Jalrakshak, your very own water-saving buddy! üíß How can I help you today?',
                options: [
                    { text: 'üíß Report a leak', next: 'REPORT_START' },
                    { text: '‚ùì Identify invisible leaks', next: 'IDENTIFY_START' }, // <-- NEW OPTION ADDED
                    { text: 'üí° Learn how to save water', next: 'LEARN_START' },
                    { text: 'ü§ù Wish to partner with us', next: 'PARTNER_START' }
                ],
                type: 'menu'
            },
            'REPORT_START': {
                message: 'Right! Please click a picture of the leak.',
                options: [
                    { text: 'üì∑ Click to attach photo', next: 'REPORT_SEVERITY' }
                ],
                type: 'button'
            },
            'REPORT_SEVERITY': {
                message: 'Great! Now, to help us understand the seriousness, which of these does your leak look most similar to?',
                options: [
                    { text: 'Invisible Leak', img: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQLw5DTQENgx3Pz3dAfoBSofjpjrpqTdmt8RQ&s', next: 'REPORT_FREQUENCY' },
                    { text: 'Steady Stream', img: 'https://nz.rs-cdn.com/images/nwsz8-56ag4/blog/e9203d0977231ff2ec4686bd5061c32c__17a6/zoom793x594z100000cw793@2x.jpg.webp?etag=b0a8086cd2a2fe7966be5b0cf8a43ea0', next: 'REPORT_FREQUENCY' },
                    { text: 'Noticeable Leak', img: 'https://www.ultratechcement.com/content/dam/ultratechcement/new-blogs-images/water-proofing-8.jpg', next: 'REPORT_FREQUENCY' },
                    { text: 'Minor Drip', img: 'https://www.comfortecphc.com/_managedFiles/posts/1522255085.jpeg', next: 'REPORT_FREQUENCY' }
                ],
                type: 'severity'
            },
            'REPORT_FREQUENCY': {
                message: 'Understood. Next, did you see this leak for the first time, or has it been happening frequently?',
                options: [
                    { text: 'First Time', next: 'REPORT_LOCATION' },
                    { text: 'Happening Frequently', next: 'REPORT_LOCATION' }
                ],
                type: 'button'
            },
            'REPORT_LOCATION': {
                message: 'To finish the complaint, please provide the location of the leak.',
                options: [
                    { text: 'üìç Share Location', next: 'REPORT_COMMENTS' }
                ],
                type: 'button'
            },
            'REPORT_COMMENTS': {
                message: 'Thanks! Is there anything else you\'d like to add?',
                options: [
                    { text: 'Yes, I have comments', next: 'REPORT_ADD_COMMENT' },
                    { text: 'No, that\'s all', next: 'REPORT_COMPLETE' }
                ],
                type: 'button'
            },
            'REPORT_ADD_COMMENT': {
                message: 'Please type your comments below.',
                type: 'input',
                next: 'REPORT_COMPLETE'
            },
            'REPORT_COMPLETE': {
                message: 'Thank you so much for your report! You\'ve done a great job. Your unique leak ID is <strong>JAL-78B341</strong>. You can use this for any future reference.',
                next: 'REPORT_RESOLVED',
                delay: 5000
            },
            'REPORT_RESOLVED': {
                message: 'Update on JAL-78B341: Congratulations! The leak you reported has been fixed. Thanks to you, an estimated 50,000 litres of water will be saved per year. You are a true Jalrakshak! üôè',
                options: [
                    { text: 'Back to Main Menu', next: 'START' }
                ],
                type: 'button'
            },

            'LEARN_START': {
                message: 'Great choice! Learning to save water is the first step to becoming a true Jalrakshak.\n\nHere are a few quick tips:',
                next: 'LEARN_START_TIP2',
                delay: 2400
            },
            'LEARN_START_TIP2': {
                message: '1. üö∞ Collect Cold Water: While waiting for tap water to heat up, collect the cold water. Use it for the kettle, watering plants, or flushing.',
                next: 'LEARN_START_TIP3',
                delay: 3600
            },
            'LEARN_START_TIP3': {
                message: '2. üöΩ Flush Reducer: Place a full 1-2 litre plastic bottle or a brick in your toilet cistern to displace water. This reduces the water volume of every flush.',
                options: [
                    { text: 'More tips, please!', next: 'LEARN_MORE' },
                    { text: 'Back to Main Menu', next: 'START' }
                ],
                type: 'button',
                delay: 3000
            },
            'LEARN_MORE': {
                message: 'You got it! Here are some more advanced ideas:',
                next: 'LEARN_MORE_TIP4',
                delay: 2400
            },
            'LEARN_MORE_TIP4': {
                message: '3. üå± Use a Mulch Blanket: Apply a thick layer of mulch (like bark chips or straw) over your garden beds. This dramatically reduces water evaporation from the soil.',
                next: 'LEARN_MORE_TIP5',
                delay: 3600
            },
            'LEARN_MORE_TIP5': {
                message: '4. üî• Insulate Hot Water Pipes: Insulating exposed hot water pipes helps you get hot water faster, reducing the water you run down the drain while waiting.',
                next: 'LEARN_MORE_TIP6',
                delay: 3600
            },
            'LEARN_MORE_TIP6': {
                message: '5. üß∫ Re-use Rinse Water: If possible, re-use the final rinse water from your laundry for the next wash\'s initial cycle or for flushing toilets.',
                next: 'LEARN_MORE_TIP7',
                delay: 3600
            },
            'LEARN_MORE_TIP7': {
                message: '6. ü•ï Use a Basin (Waskom): When washing vegetables or defrosting food, place a basin in the sink to catch the water. Re-use this water for houseplants.\n\nRemember, every drop counts! üíß',
                options: [
                    { text: 'Back to Main Menu', next: 'START' }
                ],
                type: 'button',
                delay: 3000
            },

            'PARTNER_START': {
                message: 'That\'s fantastic! We\'re always looking for partners‚Äîwhether you\'re an individual, a community group, or a plumbing service.',
                options: [
                    { text: 'I\'m a Plumber/Service', next: 'PARTNER_PLUMBER' },
                    { text: 'I\'m a Community Group', next: 'PARTNER_COMMUNITY' },
                    { text: 'Other', next: 'PARTNER_OTHER' }
                ],
                type: 'button'
            },
            'PARTNER_PLUMBER': {
                message: 'That\'s exactly who we need! Our registered plumbers are the heroes who close the loop on leak reports. Please email our Plumber Support manager at plumberSupport@jalrakshak.org.',
                options: [
                    { text: 'Back to Main Menu', next: 'START' }
                ],
                type: 'button'
            },
            'PARTNER_COMMUNITY': {
                message: 'Awesome! Community groups are the heart of Jalrakshak. We can provide resources for awareness campaigns and local events. Please email our community manager at community@jalrakshak.org.',
                options: [
                    { text: 'Back to Main Menu', next: 'START' }
                ],
                type: 'button'
            },
            'PARTNER_OTHER': {
                message: 'We\'d love to hear your idea. Please send a brief proposal to partners@jalrakshak.org and our team will get back to you!',
                options: [
                    { text: 'Back to Main Menu', next: 'START' }
                ],
                type: 'button'
            },

            'IDENTIFY_START': {
                message: 'Hidden leaks are the most costly kind! I can teach you a few ways to find them. What method do you want to learn about?',
                options: [
                    { text: 'Test my water meter', next: 'IDENTIFY_METER' },
                    { text: 'Look for physical signs', next: 'IDENTIFY_SIGNS' },
                    { text: 'Check indoor plumbing', next: 'IDENTIFY_INDOOR' },
                    { text: 'Back to Main Menu', next: 'START' }
                ],
                type: 'button'
            },
            'IDENTIFY_METER': {
                message: 'This is the most definitive test!\n\n1. Turn off all taps, appliances, and irrigation.\n2. Read your water meter.\n3. Wait 15‚Äì30 minutes, then re-read the meter.\n\nIf the reading has changed, you have a leak somewhere on your property.',
                options: [
                    { text: 'Learn other methods', next: 'IDENTIFY_START' },
                    { text: 'Back to Main Menu', next: 'START' }
                ],
                type: 'button',
                delay: 2000
            },
            'IDENTIFY_SIGNS': {
                message: 'Great, walk around your property and look out for these environmental changes:',
                next: 'IDENTIFY_SIGNS_1',
                delay: 2000
            },
            'IDENTIFY_SIGNS_1': {
                message: '1. üå≥ Lush/Wet Patches: A specific area of your lawn that is significantly greener, thicker, or wetter than the rest.',
                next: 'IDENTIFY_SIGNS_2',
                delay: 3000
            },
            'IDENTIFY_SIGNS_2': {
                message: '2. üçÑ Fungal Growth: Persistent moisture can cause mold or moss to grow on the soil or nearby walls.',
                next: 'IDENTIFY_SIGNS_3',
                delay: 3000
            },
            'IDENTIFY_SIGNS_3': {
                message: '3. üß± Damage/Cracks: Look for sinking or cracked pavement, soft spots, or potholes, which can be caused by water pooling underneath.',
                next: 'IDENTIFY_SIGNS_4',
                delay: 3000
            },
            'IDENTIFY_SIGNS_4': {
                message: '4. üîâ Hissing Sounds: Listen for strange bubbling or hissing sounds near your water lines. This is pressurized water escaping.',
                options: [
                    { text: 'Learn other methods', next: 'IDENTIFY_START' },
                    { text: 'Back to Main Menu', next: 'START' }
                ],
                type: 'button',
                delay: 2000
            },
            'IDENTIFY_INDOOR': {
                message: 'Indoors, you can look for these clues:',
                next: 'IDENTIFY_INDOOR_1',
                delay: 2000
            },
            'IDENTIFY_INDOOR_1': {
                message: '1. üìâ Sudden Drop in Pressure: If your overall water pressure drops inside your house, it\'s a sign that the leak might be reducing the flow of water to your fixtures.',
                next: 'IDENTIFY_INDOOR_2',
                delay: 3000
            },
            'IDENTIFY_INDOOR_2': {
                message: '2. üöΩ The Toilet Dye Test: Add food coloring to your toilet tank. If the color appears in the bowl after 15 minutes (without flushing), your toilet has a leak.',
                next: 'IDENTIFY_INDOOR_3',
                delay: 3000
            },
            'IDENTIFY_INDOOR_3': {
                message: '3. üíß Water Quality Issues: Rusty water or air bubbles in your tap water can sometimes point to issues with underground pipes.',
                next: 'IDENTIFY_INDOOR_4',
                delay: 3000
            },
            'IDENTIFY_INDOOR_4': {
                message: '4. üí∏ High Bills: The clearest sign! An unexplained, sudden spike in your water bill often means a hidden leak.',
                options: [
                    { text: 'Learn other methods', next: 'IDENTIFY_START' },
                    { text: 'Back to Main Menu', next: 'START' }
                ],
                type: 'button',
                delay: 2000
            }
        };

        function formatTime() {
            return new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true });
        }

        function setBotTyping(isTyping) {
            botTyping = isTyping;
            botStatus.textContent = isTyping ? 'typing...' : 'online';
        }

        function enableUserInput() {
            userInput.disabled = false;
            sendButton.disabled = false;
            sendButton.classList.remove('cursor-not-allowed');
            userInput.placeholder = 'Type your comment...';
            userInput.focus();
        }

        function disableUserInput() {
            userInput.disabled = true;
            sendButton.disabled = true;
            sendButton.classList.add('cursor-not-allowed');
            userInput.placeholder = 'Type a message...';
            userInput.value = '';
        }

        function addMessage(from, type, content) {
            const time = formatTime();
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `w-full flex flex-col chat-message ${from === 'user' ? 'user-message' : ''}`;
            
            let bubble;
            if (type === 'text') {
                bubble = document.createElement('div');
                bubble.className = `chat-bubble ${from}`;
                bubble.innerHTML = `${content}<span class="chat-time">${time}</span>`;
            } else if (type === 'image') {
                bubble = document.createElement('div');
                const bubbleClasses = from === 'user' ? 'image-bubble user' : 'image-bubble bot'; 
                bubble.className = bubbleClasses;
                const imgClasses = 'rounded-lg max-w-[250px]'; 
                bubble.innerHTML = `<img src="${content}" alt="Image" class="${imgClasses}"><div class="text-right p-1"><span class="chat-time">${time}</span></div>`;
            } else if (type === 'location') {
                bubble = document.createElement('div');
                bubble.className = `location-bubble ${from}`;
                bubble.innerHTML = `<div class="w-[250px]"><img src="https://i0.wp.com/www.smartprix.com/bytes/wp-content/uploads/2024/04/google-maps-ev-car-charging-station.jpeg?fit=1298%2C656&ssl=1" alt="Map location" class="rounded-t-lg w-full h-24 object-cover"><div class="bg-white p-2 rounded-b-lg"><p class="font-semibold text-sm text-gray-800">${content.name}</p><p class="text-xs text-gray-500">Shared Location</p></div></div><div class="text-right p-1"><span class="chat-time">${time}</span></div>`;
            } else if (type === 'options') {
                bubble = document.createElement('div');
                bubble.className = 'options-container bot';
                let buttonsHTML = `<div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">`;
                content.options.forEach((opt, index) => {
                    const borderClass = index > 0 ? 'border-t border-gray-200' : '';
                    if (content.type === 'menu') {
                        buttonsHTML += `<button class="w-full text-blue-600 font-medium text-left p-3 flex items-center space-x-3 chat-button ${borderClass}" data-next="${opt.next}" data-text="${opt.text}">
                                            <span>${opt.text.split(' ')[0]}</span>
                                            <span>${opt.text.substring(opt.text.indexOf(' ') + 1)}</span>
                                        </button>`;
                    } else {
                        buttonsHTML += `<button class="w-full text-blue-600 text-center p-3 font-medium chat-button ${borderClass}" data-next="${opt.next}" data-text="${opt.text}">${opt.text}</button>`;
                    }
                });
                buttonsHTML += '</div>';
                bubble.innerHTML = buttonsHTML;
            } else if (type === 'severity_options') {
                bubble = document.createElement('div');
                bubble.className = `options-container bot`;
                let optionsHTML = '<div class="bg-white rounded-xl border border-gray-200 p-3 shadow-sm"><div class="grid grid-cols-2 gap-2">';
                content.options.forEach(opt => {
                    optionsHTML += `<div class="text-center rounded-lg border-2 border-gray-200 p-1 cursor-pointer severity-button chat-button" data-next="${opt.next}" data-text="${opt.text}">
                                        <img src="${opt.img}" class="rounded-md mx-auto mb-2 h-24 w-full object-cover pointer-events-none">
                                        <p class="text-xs font-semibold text-gray-700 pointer-events-none">${opt.text}</p>
                                    </div>`;
                });
                optionsHTML += '</div></div>';
                bubble.innerHTML = optionsHTML;
            }

            messageWrapper.appendChild(bubble);
            chatArea.appendChild(messageWrapper);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        /* --- NEW FUNCTION TO ADD DATE DIVIDER --- */
        function addDateDivider(dateText = "Today") {
            const divider = document.createElement('div');
            divider.className = 'chat-date';
            divider.textContent = dateText;
            chatArea.appendChild(divider);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function botResponse(nextState) {
            currentState = nextState;
            const flow = botFlow[currentState];
            if (!flow) return;
            setBotTyping(true);

            const lastBotMessage = chatArea.querySelector('.options-container:last-child');
            if (lastBotMessage) {
                lastBotMessage.querySelectorAll('button, .chat-button').forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                    btn.classList.remove('chat-button');
                });
            }

            if (currentState === 'REPORT_RESOLVED') {
                const imageUrl = 'https://i.ibb.co/7xQNjWfk/a0dd8ea4-bca5-410c-842f-c2f031030823.jpg';
                addMessage('bot', 'image', imageUrl);
                setTimeout(() => {
                    setBotTyping(false);
                    if (flow.message) addMessage('bot', 'text', flow.message);
                    if (flow.type === 'button') addMessage('bot', 'options', { type: 'button', options: flow.options });
                }, 1500);
                return;
            }

            // Set a delay for the current message to appear
            const messageDelay = flow.delay && flow.message ? 1200 : (flow.message ? 1200 : 0);
            
            if (flow.message) {
                 setTimeout(() => {
                    setBotTyping(false);
                    addMessage('bot', 'text', flow.message);
                }, messageDelay);
            } else {
                setBotTyping(false);
            }

            // Handle options (buttons, etc.)
            const optionsDelay = flow.delay ? flow.delay : (flow.message ? messageDelay + 500 : 500);
            
            setTimeout(() => {
                if (flow.type === 'menu') addMessage('bot', 'options', { type: 'menu', options: flow.options });
                else if (flow.type === 'button') addMessage('bot', 'options', { type: 'button', options: flow.options });
                else if (flow.type === 'severity') addMessage('bot', 'severity_options', { options: flow.options });
                else if (flow.type === 'input') enableUserInput();
            }, optionsDelay);


            // Handle auto-advancing to the next state
            if (flow.next && !flow.options && flow.type !== 'input') {
                const nextStateDelay = flow.delay ? flow.delay : 1200;
                setTimeout(() => {
                    if (currentState === 'REPORT_COMPLETE') {
                        addDateDivider("Today");
                    }
                    botResponse(flow.next);
                }, nextStateDelay);
            }
        }

        chatArea.addEventListener('click', (e) => {
            if (botTyping) return;
            const button = e.target.closest('.chat-button');
            if (button && !button.disabled) {
                const next = button.dataset.next;
                const text = button.dataset.text;
                addMessage('user', 'text', text);

                if (next === 'REPORT_SEVERITY') {
                    setTimeout(() => {
                        addMessage('user', 'image', 'https://phdyuma.com/wp-content/uploads/2024/02/PL-1495624975-Water-leakage-at-shut-off-valve-and-pipe-1024x683.jpg');
                        setTimeout(() => botResponse(next), 3000);
                    }, 3000);
                    return;
                } else if (next === 'REPORT_COMMENTS') {
                    setTimeout(() => {
                        addMessage('user', 'location', { name: 'Johannesberg, South Africa' });
                        setTimeout(() => botResponse(next), 3000);
                    }, 3000);
                    return;
                } else if (next) botResponse(next);
            }
        });

        function handleTextInput() {
            const text = userInput.value.trim();
            if (text && currentState === 'REPORT_ADD_COMMENT') {
                addMessage('user', 'text', text);
                disableUserInput();
                botResponse(botFlow[currentState].next);
            }
        }

        sendButton.addEventListener('click', handleTextInput);
        userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleTextInput(); });

        function startChat() {
            addMessage('user', 'text', 'hello');
            setTimeout(() => botResponse('START'), 1000);
        }

        startChat();
    </script>
</body>
</html>
